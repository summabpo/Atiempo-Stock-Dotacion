{% extends 'layouts/base.html' %}
{% block content %}

<div class="container">
  <br>
  <div class="row">
    <div class="col-12 col-md-12 offset-md-12">
      <br>
      <div class="card">
        <div class="cadr-body">
  <h2>Crear Grupo de Dotaci√≥n</h2>
  <form method="post">
    {% csrf_token %}
    <div class="card mb-5">
     <div class="card-body">
  <div class="row">
    <div class="col-md-6 mb-3">
      {{ form.cargos.label_tag }} {{ form.cargos }}
      {% if form.cargos.errors %}
        <div class="text-danger">{{ form.cargos.errors }}</div>
      {% endif %}
    </div>

    <div class="col-md-6 mb-3">
      {{ form.cliente.label_tag }} {{ form.cliente }}
      {% if form.cliente.errors %}
        <div class="text-danger">{{ form.cliente.errors }}</div>
      {% endif %}
    </div>

    <div class="col-md-6 mb-3">
      {{ form.ciudades.label_tag }} {{ form.ciudades }}
      {% if form.ciudades.errors %}
        <div class="text-danger">{{ form.ciudades.errors }}</div>
      {% endif %}
    </div>

    <div class="col-md-6 mb-3">
      {{ form.genero.label_tag }} {{ form.genero }}
      {% if form.genero.errors %}
        <div class="text-danger">{{ form.genero.errors }}</div>
      {% endif %}
    </div>
  </div>
</div>
    </div>

    <h4 class="mt-4">Productos del Grupo</h4>
   <div id="formset-container">
  {{ formset.management_form }}
  {% for form in formset %}
    <div class="formset-item border p-3 mb-2 bg-light rounded">
      {% for field in form.visible_fields %}
        <div class="mb-2">
          {{ field.label_tag }} {{ field }}
          {% if field.errors %}<div class="text-danger">{{ field.errors }}</div>{% endif %}
        </div>
      {% endfor %}

      <!-- Bot√≥n para quitar este producto -->
      <button type="button" class="btn btn-danger btn-sm remove-form">Quitar</button>
    </div>
  {% endfor %}
</div>

<!-- Bot√≥n para a√±adir productos -->
<button type="button" class="btn btn-outline-primary mb-3" id="add-form">Agregar otro producto</button>
    <br>
    <button type="submit" class="btn btn-success">Guardar Grupo</button>
    <a href="{% url 'listar_grupos_dotacion' %}" class="btn btn-secondary">Cancelar</a>
  </form>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {

  function aplicarSelect2() {
    $('select').select2({
      width: '100%',
      theme: 'classic',
      placeholder: "Seleccione una opci√≥n",
      allowClear: true
    });
  }

  $(document).ready(function () {
  $('select.select2').select2({
    width: '100%',
    theme: 'classic',
    placeholder: 'Seleccione una o varias opciones',
    allowClear: true
    });
  });

  aplicarSelect2();

  const formsetContainer = document.getElementById('formset-container');
  const addFormButton = document.getElementById('add-form');
  const totalForms = document.getElementById('id_productos-TOTAL_FORMS');

  // üü¢ Ocultar productos ya seleccionados
  function actualizarOpcionesDisponibles() {
    const selects = document.querySelectorAll('select[name^="productos-"][name$="-producto"]');

    // Obtiene todos los valores seleccionados
    const valoresSeleccionados = Array.from(selects).map(s => s.value).filter(v => v !== "");

    selects.forEach(select => {
      const selectedValue = select.value;

      // Iteramos sobre cada opci√≥n
      $(select).find('option').each(function () {
        const optionValue = this.value;

        // Mostrar la opci√≥n si no est√° seleccionada en otro campo
        if (
          optionValue === "" || // opci√≥n vac√≠a
          optionValue === selectedValue || // opci√≥n actual del campo
          !valoresSeleccionados.includes(optionValue)
        ) {
          $(this).prop('disabled', false);
        } else {
          $(this).prop('disabled', true);
        }
      });

      // üîÅ Refrescar Select2
      $(select).trigger('change.select2');
    });
  }

  // üü° Al cambiar cualquier select, refrescamos opciones disponibles
  document.addEventListener('change', e => {
    if (e.target.matches('select[name^="productos-"][name$="-producto"]')) {
      actualizarOpcionesDisponibles();
    }
  });

  // ‚ûï Agregar nueva fila
  addFormButton.addEventListener('click', () => {
    const currentFormCount = parseInt(totalForms.value);
    const lastForm = formsetContainer.querySelector('.formset-item:last-of-type');

    $(lastForm).find('select').select2('destroy');

    const newForm = lastForm.cloneNode(true);

    // Limpiar valores del clon
    newForm.querySelectorAll('input, select').forEach(input => {
      input.value = '';
    });

    // Actualizar √≠ndices
    newForm.innerHTML = newForm.innerHTML.replaceAll(`-${currentFormCount - 1}-`, `-${currentFormCount}-`);
    newForm.innerHTML = newForm.innerHTML.replaceAll(`_${currentFormCount - 1}`, `_${currentFormCount}`);

    formsetContainer.appendChild(newForm);
    totalForms.value = currentFormCount + 1;

    aplicarSelect2();
    actualizarOpcionesDisponibles();
  });

  // üî¥ Validar duplicados antes del submit
  document.querySelector('form').addEventListener('submit', function (e) {
    const selects = document.querySelectorAll('select[name^="productos-"][name$="-producto"]');
    const valores = [];
    let duplicado = false;

    selects.forEach(select => {
      const val = select.value;
      if (val) {
        if (valores.includes(val)) {
          duplicado = true;
        } else {
          valores.push(val);
        }
      }
    });

    if (duplicado) {
      e.preventDefault();
      alert("No puedes seleccionar el mismo producto m√°s de una vez.");
    }
  });

  // Ejecutar en el primer renderizado
  actualizarOpcionesDisponibles();
});

document.addEventListener("DOMContentLoaded", function() {
    let formsetContainer = document.getElementById("formset-container");
    let addButton = document.getElementById("add-form");

    // Total forms de Django (oculto en el management_form)
    let totalForms = document.getElementById("id_" + "{{ formset.prefix }}" + "-TOTAL_FORMS");

    // üëâ Agregar producto
    addButton.addEventListener("click", function() {
        let formIndex = totalForms.value;
        let emptyForm = formsetContainer.querySelector(".formset-item").cloneNode(true);

        // Limpiar valores de inputs en el clon
        emptyForm.querySelectorAll("input, select").forEach(el => {
            el.value = "";
            if (el.type === "checkbox") el.checked = false;
        });

        // Reemplazar √≠ndices __prefix__ con el nuevo index
        emptyForm.innerHTML = emptyForm.innerHTML.replaceAll(
            new RegExp(`-${formIndex - 1}-`, "g"),
            `-${formIndex}-`
        );

        formsetContainer.appendChild(emptyForm);
        totalForms.value = parseInt(formIndex) + 1;

        attachRemoveButtons();
    });

    // üëâ Quitar producto
    function attachRemoveButtons() {
        document.querySelectorAll(".remove-form").forEach(btn => {
            btn.onclick = function() {
                btn.closest(".formset-item").remove();
                // Actualizar TOTAL_FORMS
                let items = document.querySelectorAll(".formset-item").length;
                totalForms.value = items;
            };
        });
    }

    // Inicializar
    attachRemoveButtons();
});
</script>
{% endblock %}