{% extends 'layouts/base.html' %}
{% load static %}

{% load humanize %}

{% block content %}

<div class="content-wrapper">
    <section class="content-header">
        <div class="card bg-light mb-3">
            <div class="card-header">
                <h3 class="mb-0">Orden de Compra #{{ orden.id }}</h3>
            </div>
            <div class="card-body text-dark">
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label>Fecha Orden Compra:</label>
                        <input class="form-control" type="text" value="{{ orden.fecha_creacion }}" readonly>
                    </div>
                    <div class="col-md-6 mb-2">
                        <label>Proveedor:</label>
                        <input type="text" class="form-control" value="{{ orden.proveedor.nombre }}" readonly>
                    </div>
                    <div class="col-md-6 mb-2">
                        <label>Ciudad Proveedor:</label>
                        <input type="text" class="form-control" value="{{ orden.proveedor.ciudad }}" readonly>
                    </div>
                    <div class="col-md-6 mb-2">
                        <label>Estado:</label>
                        <input type="text" class="form-control" value="{{ orden.get_estado_display }}" readonly>
                    </div>
                    <div class="col-md-12">
                        <label>Observaciones:</label>
                        <input type="text" class="form-control" value="{{ orden.observaciones }}">
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="card">
        <h3>Productos en la Orden</h3>

        <form method="post" action="{% url 'comprar_orden' orden.id %}">
            {% csrf_token %}
            <table class="table table-bordered" style="color: black;" id="tablaProductos">
                <thead class="thead-dark">
                    <tr style="text-align: center;">
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio Unitario</th>
                <th>Subtotal</th>
                <th>Acción</th>
                    </tr>
                </thead>
                <tbody>

                    {% for item in items %}
                    <!-- <p>Producto: {{ item.producto.nombre }}</p>
    <p>Cantidad: {{ item.cantidad }}</p>
    <p>Precio: {{ item.precio_unitario }}</p> -->
    
                    <tr>
                        <td>
                            {{ item.producto.nombre }}
                            <input type="hidden" name="productos[]" value="{{ item.producto.id }}">
                        </td>
                        <td>
                            <input type="number" name="cantidades[]" class="form-control text-center" value="{{ item.cantidad }}" min="1" onchange="actualizarSubtotal(this)">
                        </td>
                        <td>
                            <input type="text"  class="form-control text-right precio" value="{{ item.precio_unitario|floatformat:2|intcomma }}"  onchange="actualizarSubtotal(this)">
                            <input type="hidden" class="precio-hidden" value="{{ item.precio_unitario }}">
                        </td>
                        <td class="subtotal text-right">
                            {{ item.subtotal|floatformat:2|intcomma }}
                            <input type="hidden" name="subtotales[]" class="subtotal-hidden" value="{{ item.subtotal }}">
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm " data-id="{{ item.producto.id }}" onclick="quitarProducto(this)">
                                <i class="fa fa-times"></i>
                            </button>
                            
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tbody style="color: black;"></tbody>
                <tfoot style="color: black;">
                    <tr >
                      <td colspan="3" class="text-end"><strong>Total:</strong></td>
                      <td id="totalOrden"  class="text-right">COP {{ orden.total|floatformat:2|intcomma }}</td>
                      <td></td>
                      <input type="hidden" name="total_orden" id="inputTotalOrden">
                    </tr>
                  </tfoot>
            </table>
            {% if orden.get_estado_display == 'generada' %}
            <button type="submit" class="btn btn-success">Guardar Entrada</button>
            {% endif %}
        </form>
    </section>
</div>


{% block extra_js %}
<script>
    console.log("Hola Comprar Orden");

    // Función para formatear el número con comas y decimales
// function formatearNumero(input) {
//     console.log("hola");
    
//     // Obtener el valor del input y formatearlo con decimales y comas
//     let value = input.value.replace(/[^0-9.]/g, ''); // Quitar caracteres no numéricos
//     let formattedValue = parseFloat(value).toFixed(2); // Formatear el valor a dos decimales

//     // Establecer el valor formateado en el input
//     input.value = formattedValue;

//     // Llamar a la función para actualizar el subtotal después de formatear el precio
//     actualizarSubtotal(input);
// }

$(document).ready(function () {
    // Escuchar cambios en cualquier input.precio dentro del formulario
    $('#tablaProductos').on('change', 'input.precio', function () {
        const $inputPrecio = $(this);  // El input visible
        const $row = $inputPrecio.closest('tr');

        // Obtener el valor limpio
        const valorLimpio = parsePrecioColombiano($inputPrecio.val());

        // Actualizar el input hidden
        $row.find('input.precio-hidden').val(valorLimpio);

        $('.precio').number(true, 2);

        // Recalcular subtotal
        actualizarSubtotal(this); // Reutilizas tu función pasando el input como referencia
    });
});


function parsePrecioColombiano(valorRaw) {
    const soloNumeros = valorRaw.replace(/[^0-9.,]/g, '');  // limpia símbolos
    const tieneComaDecimal = soloNumeros.includes(',');
    const tienePuntoDecimal = soloNumeros.includes('.');

    // Caso 1: Formato colombiano: 12.500,00
    if (tieneComaDecimal && tienePuntoDecimal && soloNumeros.indexOf(',') > soloNumeros.indexOf('.')) {
        return parseFloat(soloNumeros.replace(/\./g, '').replace(',', '.'));
    }

    // Caso 2: Formato americano: 12,500.00
    if (tieneComaDecimal && tienePuntoDecimal && soloNumeros.indexOf('.') > soloNumeros.indexOf(',')) {
        return parseFloat(soloNumeros.replace(/,/g, ''));
    }

    // Caso 3: Solo coma (12,50) → 12.50
    if (!tienePuntoDecimal && tieneComaDecimal) {
        return parseFloat(soloNumeros.replace(',', '.'));
    }

    // Caso 4: Solo punto o número limpio
    return parseFloat(soloNumeros);
    console.log(soloNumeros);
    
}




// Esta función se ejecutará cuando cambien los valores de cantidad o precio
function actualizarSubtotal(input) {
    const row = input.closest('tr');

    const cantidad = parseFloat(row.querySelector('input[name="cantidades[]"]').value) || 0;
    const precioVisible = row.querySelector('input.precio');
    const hiddenSubtotal = row.querySelector('input.subtotal-hidden');
    const precioHiddenInput = row.querySelector('input.precio-hidden').value;

      

    // Convertimos el valor visible a número real
    const precioLimpio = parsePrecioColombiano(precioHiddenInput);

    // Actualizamos el hidden con ese valor
    precioHiddenInput.value = precioLimpio;

    // Calcular el subtotal
    const subtotal = cantidad * precioLimpio;

    // Actualizar la celda subtotal formateada
    const subtotalTd = row.querySelector('.subtotal');
    subtotalTd.childNodes[0].textContent = subtotal.toLocaleString('es-CO', {
        style: 'currency',
        currency: 'COP',
        minimumFractionDigits: 2
    });

    // precioHiddenInput.childNodes[0].textContent = subtotal.toLocaleString('es-CO', {
    //     minimumFractionDigits: 2
    // });

    hiddenSubtotal = row.querySelector('.subtotal');
    // Guardar el subtotal sin formato en el hidden
    //const subtotalHiddenInput = row.querySelector('input.subtotal-hidden');
    subtotalHiddenInput.value = subtotal;

    const subtotalHiddenInput = row.querySelector('input.subtotal-hidden');
if (subtotalHiddenInput) {
    subtotalHiddenInput.value = subtotal;
}

    actualizarTotalGeneral()

    
}

precioTextInput.addEventListener('change', function () {
    const nuevoValor = parsePrecioColombiano(this.value);
    row.querySelector('input.precio-hidden').value = nuevoValor;
});




function quitarProducto(button) {
    
    console.log("Hola");
        

    // Obtener el ID del producto desde el atributo data-id del botón
    const id = button.getAttribute('data-id');
    
    // Encuentra la fila más cercana al botón (la fila de la tabla)
    const row = button.closest('tr');
    
    // Si la fila existe, la eliminamos
    if (row) {
        row.remove();
    }

    // Opcional: Si necesitas hacer algo con el ID, lo puedes usar aquí
    console.log('Producto con ID', id, 'eliminado');
    
}

 

    // function formatearNumero(input) {
    //     let value = input.value;

    //     // Eliminar todos los caracteres no numéricos, excepto el punto decimal
    //     value = value.replace(/[^0-9.]/g, '');

    //     // Si tiene más de un punto decimal, eliminar los demás
    //     const parts = value.split('.');
    //     if (parts.length > 2) {
    //         value = parts[0] + '.' + parts.slice(1).join('');
    //     }

    //     // Formatear el número con dos decimales
    //     let formattedValue = parseFloat(value).toFixed(2);

    //     // Usar el formato con comas como separadores de miles
    //     formattedValue = formattedValue.replace(/\B(?=(\d{3})+(?!\d))/g, ",");

    //     // Asignar el valor formateado de nuevo al input
    //     input.value = formattedValue;
    // }


    //   Calcular total al cargar
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll('input[name="precios[]"]').forEach(input => {
            actualizarSubtotal(input);
    });

  


    //     document.querySelectorAll('.precio').forEach(input => {
    //         formatearNumero(input); // Formatear cada valor de precio
    //     });
     });


    function confirmarCompra(button) {
    const ordenId = button.getAttribute('data-orden-id');
    console.log(ordenId);
    
    if (confirm("¿Estás seguro de que deseas confirmar esta compra? Esto afectará el inventario.")) {
        window.location.href = `/comprar_orden/${ordenId}/`;
    }

    }


//     function sumarTotalPagar() {
//     var subTotal = $(".nuevoPrecioProductosuma");
//     var totalIvas = $(".nuevabaseIva");
//     var ultraProces = $(".precioulProcess");
//     var arrayVenta = [];
//     var suma = 0;

//     // Función para obtener un valor numérico válido
//     function obtenerValorNumerico(elemento) {
//         var valor = Number($(elemento).val());
//         return isNaN(valor) ? 0 : valor; // Devuelve 0 si el valor no es numérico
//     }

//     // Recopilar valores de los elementos
//     for (var i = 0; i < subTotal.length; i++) {
//         arrayVenta.push(obtenerValorNumerico(subTotal[i]));
//     }

//     for (var i = 0; i < totalIvas.length; i++) {
//         arrayVenta.push(obtenerValorNumerico(totalIvas[i]));
//     }

//     for (var i = 0; i < ultraProces.length; i++) {
//         arrayVenta.push(obtenerValorNumerico(ultraProces[i]));
//     }

//     // Sumar todos los valores
//     for (var j = 0; j < arrayVenta.length; j++) {
//         suma += arrayVenta[j];
//     }

//     console.log('Suma', suma);

//     // Actualizar elementos del DOM
//     $("#nuevoTotalVenta").val(suma);
//     $("#totalVentas").val(suma);
//     $("#nuevoTotalVenta").attr("total", suma); // Si realmente necesitas este atributo
// }



</script>
{% endblock %}

{% endblock %}