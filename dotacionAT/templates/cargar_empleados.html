{% extends 'layouts/base.html' %}

{% block content %}
{% load static %}
{% load humanize %}

<div class="card shadow">
  <div class="card-header bg-dark text-white">
    <h4 class="mb-0">Subir archivo de dotaci√≥n de empleados</h4>
  </div>
  <div class="card-body">
    <form method="post" enctype="multipart/form-data">
  {% csrf_token %}

  <!-- Campo Tipo de Entrega -->
  <div class="mb-3">
    <label class="form-label">{{ form.tipo_entrega.label }}</label>
    {{ form.tipo_entrega }}
    {% if form.tipo_entrega.errors %}
      <div class="text-danger small">
        {{ form.tipo_entrega.errors }}
      </div>
    {% endif %}
  </div>

  <!-- Campo Periodo (envuelto con ID para ocultar/mostrar) -->
  <div class="mb-3" id="periodo_field">
    <label class="form-label">{{ form.periodo.label }}</label>
    {{ form.periodo }}
    {% if form.periodo.errors %}
      <div class="text-danger small">
        {{ form.periodo.errors }}
      </div>
    {% endif %}
  </div>

  <!-- El resto de campos (como archivo) -->
  <div class="mb-3">
    <label class="form-label">{{ form.archivo.label }}</label>
    {{ form.archivo }}
    {% if form.archivo.errors %}
      <div class="text-danger small">
        {{ form.archivo.errors }}
      </div>
    {% endif %}
  </div>

  <button type="submit" onclick="iniciarProgreso()" class="btn btn-success">üì§ Subir archivo</button>
</form>

     <!-- üîπ Barra de progreso (debajo del form) -->
    <div id="progress-container" class="mt-3" style="display:none;">
      <label>‚è≥ Progreso de la carga:</label>
      <div class="progress">
        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success"
             role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
          0%
        </div>
      </div>
    </div>
  </div>


  {% if messages %}
    {% for message in messages %}
      <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  {% if empleados_sin_entrega %}
    <div class="alert alert-warning mt-4">
      <strong>‚ö†Ô∏è No se generaron entregas para los siguientes empleados:</strong>
      <ul>
        {% for motivo in empleados_sin_entrega %}
          <li>{{ motivo }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
</div>

{% endblock %}

{% block extra_js %}

<script>

  document.addEventListener("DOMContentLoaded", function() {
    const tipoEntrega = document.getElementById("id_tipo_entrega");
    const periodoField = document.getElementById("periodo_field");

    function togglePeriodo() {
        if (tipoEntrega.value === "ley") {  // üëà pon aqu√≠ el valor real que usas
            periodoField.style.display = "block";
        } else {
            periodoField.style.display = "none";
            periodoField.value= '0';
        }
    }

    // Ejecutar al cargar y cuando cambie
    togglePeriodo();
    tipoEntrega.addEventListener("change", togglePeriodo);
});


document.addEventListener('DOMContentLoaded', function () {
    const inputPeriodo = document.getElementById('id_periodo');

    inputPeriodo.addEventListener('input', function (e) {
        let valor = e.target.value.replace(/\D/g, ''); // Quita cualquier caracter que no sea n√∫mero

        // Inserta la barra autom√°ticamente despu√©s de 2 d√≠gitos
        if (valor.length > 2) {
            valor = valor.substring(0, 2) + '/' + valor.substring(2, 6);
        }

        e.target.value = valor;
    });
});


function iniciarProgreso() {
    // Mostrar la barra
    document.getElementById("progress-container").style.display = "block";
    document.getElementById("progress-bar").style.width = "0%";
    document.getElementById("progress-bar").innerText = "0%";

    // Iniciar actualizaci√≥n peri√≥dica
    setTimeout(actualizarProgreso, 1000);
}

function actualizarProgreso() {
    fetch("{% url 'progreso_carga' %}")
        .then(response => response.json())
        .then(data => {
            let porcentaje = data.progreso;  // üëà tu view devuelve {"progreso": X}
            let barra = document.getElementById("progress-bar");

            barra.style.width = porcentaje + "%";
            barra.innerText = porcentaje + "%";

            if (porcentaje < 100) {
                setTimeout(actualizarProgreso, 1000);
            } else {
                console.log("‚úÖ Proceso completado");
            }
        })
        .catch(error => console.error("Error al obtener progreso:", error));
}
</script>

{% endblock %}