{% extends 'layouts/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}

<div class="content-wrapper">
    <section class="content-header">
        <br>
        <h1 style="color: black;">
        Crear Orden de Compra
        </h1>
    </section>
            

    <div class="row">  
        <div class="col-lg-7 col-md-7 col-sm-12 col-xs-12">
    <!--=====================================
    ENTRADA PARA PROVEEDOR
    ======================================-->
    <div class="card " style="color: black;">
        <div class="card-header bg-success">
            <h3 class="card-title">Seleccione Proveedor</h3>
        </div>
        <div class="card-body">


        <table id="tablaProveedoresOrden" class="table table-striped table-responsive-sm text-center" data-page-length="1" width="100%">
            <thead class="thead-dark">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody id="tableBody_proveedorOrden" style="color: black;"></tbody>
        </table>
    </div>
    </div>
    <br>
    <div class="card">
        
        <form role="form" method="post" class="formularioCompra">
            {% csrf_token %}
        <div class="box-body">
        <div class="box">

              <!--=====================================
    ENTRADA FECHA FACTURA DE COMPRA
    ======================================-->

    <!--=====================================
    ENTRADA DEL PROVEEDOR
    ======================================-->
    <!-- <div class="form-group row nuevoProveedor">
    </div>-->
    <input type="hidden" id="listaProveedor" name="listaProveedor">
    

    <div class="form-group row nuevoProveedor mt-3">
        <!-- <label class="col-sm-12 col-form-label"><strong>Proveedor Seleccionado</strong></label> -->
        <div class="col-sm-12">
            <table class="table table-bordered text-center" id="proveedorSeleccionado">
                <thead class="thead-dark">
                    <tr>
                        <th>Nombre Proveedor</th>
                        <th>Ciudad</th>
                        <th>Telefono</th>
                        <th>Quitar</th>
                    </tr>
                </thead>
                <tbody style="color: black;"></tbody>
            </table>
        </div>
    </div>
</br> 
    <!--=====================================
    ENTRADA PARA AGREGAR PRODUCTO
    ======================================-->
  
    <!-- <div class="form-group row nuevoProductoCompra"> -->
  
    <input type="hidden" id="listaProductos" name="listaProductos">

    <div class="form-group row nuevoProductoCompra mt-3">
        <!-- <label class="col-sm-12 col-form-label"><strong>Productos Seleccionados</strong></label> -->
        <div class="col-sm-12">
            <table class="table table-bordered text-center" id="productosSeleccionados">
                <thead class="thead-dark">
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio</th>
                        <th>Subtotal</th>
                        <th>Quitar</th>
                    </tr>
                </thead>
                <tbody style="color: black;"></tbody>
                <tfoot style="color: black;">
                    <tr >
                      <td colspan="3" class="text-end"><strong>Total:</strong></td>
                      <td id="totalOrden"  class="text-right">COP 0.00</td>
                      <td></td>
                      <input type="hidden" name="total_orden" id="inputTotalOrden">
                    </tr>
                  </tfoot>
            </table>
        </div>
    </div>
    <!--=====================================
    BOTÓN PARA AGREGAR PRODUCTO
    ======================================-->
   
    


        </div>
    </div>

  

    <button type="submit" class="btn btn-success">Guardar Orden</button>        
</form>
        
        </div>
    </div>



<!-- <div class="box-header with-border"></div> -->
<div class="col-lg-4 col-md-4 col-sm-12 col-xs-12">
    <div class="card " style="color: black;">
        <div class="card-header bg-warning">
            <h3 class="card-title" style="color: white;">Seleccione Producto</h3>
        </div>
        <div class="card-body">
     
        <table class="table table-striped table-hover table-responsive-sm text-center " id="datatableProductosOrden">
            <thead class="thead-dark">
              <tr>
                <th >ID</th>
                <th >Nombre</th>
                <th >Acciones</th>
              </tr>
            </thead>
           <tbody id="tableBody_productosOrden" style="color: black;"></tbody>
      
            </table>

    </div>
    </div>
    </div>
    

</div>
   
</div>
  



<!-- Scripts -->

{% block extra_js %}



<!-- 
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
 -->

<script>




let dataTableProveedores;
let dataTableProductos;

let proveedoresInitialized = false;
let productosInitialized = false;

const dataTableOptions = {
    columnDefs: [
        { className: "text-center", targets: "_all" },
        { orderable: false, targets: -1 }
    ],
    pageLength: 1,
    destroy: true,
    language: {
        processing: "Procesando...",
        lengthMenu: "Mostrar _MENU_ registros",
        zeroRecords: "No se encontraron resultados",
        emptyTable: "Ningún dato disponible en esta tabla",
        info: "Mostrando registros del _START_ al _END_ de un total de _TOTAL_",
        infoEmpty: "Mostrando 0 de 0 registros",
        infoFiltered: "(filtrado de un total de _MAX_ registros)",
        search: "Buscar:",
        paginate: {
            first: "Primero",
            last: "Último",
            next: "Siguiente",
            previous: "Anterior"
        },
    },
    lengthChange: false,
};

// ✅ Tabla de Proveedores
const initDataTableProveedores = async () => {
    if (proveedoresInitialized) {
        dataTableProveedores.destroy();
    }

    await cargarProveedores();

    const table = document.getElementById('tablaProveedoresOrden');
    if (table) {
        dataTableProveedores = $('#tablaProveedoresOrden').DataTable(dataTableOptions);
        proveedoresInitialized = true;
    }
};

const cargarProveedores = async () => {
    try {
        const response = await fetch('/list_proveedores/');
        const data = await response.json();
        const tableBody = document.getElementById('tableBody_proveedorOrden');

        if (tableBody) {
            let content = ``;

            data.proveedores.forEach(proveedor => {
                const activo = proveedor.activo === true || proveedor.activo === "True";
                content += `
                    <tr>
                        <td>${proveedor.id_proveedor}</td>
                        <td>${proveedor.nombre}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-primary"
                                onclick="seleccionarProveedor('${proveedor.id_proveedor}', '${proveedor.nombre}', '${proveedor.id_ciudad}', '${proveedor.telefono}')">
                                Seleccionar
                            </button>
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = content;
        }

    } catch (error) {
        console.error("Error al cargar proveedores:", error);
    }
};

// function seleccionarProveedor(id, nombre) {
//     // Setear valores ocultos
//     document.getElementById('listaProveedor').value = id;

//     // Insertar nombre visualmente en el div
//     const divProveedor = document.querySelector('.nuevoProveedor');
//     divProveedor.innerHTML = `
//         <label class="col-sm-4 col-form-label">Proveedor seleccionado:</label>
//         <div class="col-sm-8">
//             <input type="text" class="form-control" value="${nombre}" readonly>
//         </div>
//     `;
// }

function seleccionarProveedor(id, nombre, ciudad, telefono) {
    // Prevenir múltiples selecciones
    const tbody = document.querySelector("#proveedorSeleccionado tbody");
    tbody.innerHTML = ''; // Limpiar contenido anterior

    const fila = document.createElement("tr");
    fila.setAttribute("data-id", id);
    fila.innerHTML = `
        <td>${nombre}<input type="hidden" name="proveedor" value="${id}"></td>
        <td>${ciudad}<input type="hidden" value="${ciudad}"></td>
        <td>${telefono}<input type="hidden" value="${telefono}"></td>
        <td>
            <button type="button" class="btn btn-danger btn-sm" onclick="quitarProveedor()">
                <i class="fa fa-times"></i>
            </button>
        </td>
    `;
    tbody.appendChild(fila);
}

function quitarProveedor() {
    const tbody = document.querySelector("#proveedorSeleccionado tbody");
    tbody.innerHTML = '';
    document.getElementById('listaProveedor').value = ''; // limpiar input oculto
}


const dataTableOptionsOrden = {
    columnDefs: [
        { className: "text-center", targets: "_all" },
        { orderable: false, targets: -1 }
    ],
    pageLength: 10,
    destroy: true,
    language: {
        processing: "Procesando...",
        lengthMenu: "Mostrar _MENU_ registros",
        zeroRecords: "No se encontraron resultados",
        emptyTable: "Ningún dato disponible en esta tabla",
        info: "Mostrando registros del _START_ al _END_ de un total de _TOTAL_",
        infoEmpty: "Mostrando 0 de 0 registros",
        infoFiltered: "(filtrado de un total de _MAX_ registros)",
        search: "Buscar:"   
    },
    paging: false,
    info: false,
};




// ✅ Tabla de Productos
const initDataTableProductos = async () => {
    if (productosInitialized) {
        dataTableProductos.destroy();
    }

    await cargarProductos();

    const table = document.getElementById('datatableProductosOrden');
    if (table) {
        dataTableProductos = $('#datatableProductosOrden').DataTable(dataTableOptionsOrden);
        productosInitialized = true;
    }
};

const cargarProductos = async () => {
    try {
        const response = await fetch('/list_productos/');
        const data = await response.json();
        const tableBody = document.getElementById('tableBody_productosOrden');

        if (tableBody) {
            let content = ``;
            data.productos.forEach(producto => {
                const activo = producto.activo === "True" || producto.activo === true;
                content += `
                    <tr class="text-center">
                        <td>${producto.id_producto}</td>
                        <td>${producto.nombre}</td>
                        <td>
                            
                                  <button class="btn btn-sm btn-primary" onclick="agregarProductoAOrden('${producto.id_producto}', '${producto.nombre}')">
        Agregar
    </button>
                        </td>
                    </tr>
                `;
            });
            tableBody.innerHTML = content;
        }

    } catch (error) {
        alert("Error al obtener productos.");
        console.error("Error al obtener productos:", error);
    }
};

// ✅ Llamamos ambas al cargar la página
window.addEventListener("load", async () => {
    await initDataTableProveedores();
    await initDataTableProductos();
    console.log("Página cargada");
});


let productosAgregados = [];

function agregarProductoAOrden(id, nombre) {
    // Evitar duplicados
    if (productosAgregados.includes(id)) {
        alert("Este producto ya ha sido agregado.");
        return;
    }

    productosAgregados.push(id);

    const tbody = document.querySelector("#productosSeleccionados tbody");
    const fila = document.createElement("tr");
    fila.setAttribute("data-id", id);

    fila.innerHTML = `
        <td>${nombre}<input type="hidden" name="productos[]" value="${id}"></td>
        <td>
            <input type="text" name="cantidades[]" class="form-control text-center cantidad" value="1"    min="0" step="0.01" onchange="actualizarSubtotal(this)"  required></td>

        <td><input type="text" name="precios[]" class="form-control text-right valorUnitario"   
      
     
    onchange="actualizarSubtotal(this)"   required></td>

        <td class="subtotal text-right">0.00</td>
        <td>


            <button type="button" class="btn btn-danger btn-sm" onclick="quitarProducto(${id}, this)">
                <i class="fa fa-times"></i>
            </button>
        </td>
    `;
    tbody.appendChild(fila);
    
    console.log(typeof $.fn.number);
    
    $(fila).find(".valorUnitario").number(true, 2);
    // $(fila).find(".cantidad").number(true);
    $(fila).find(".subtotal").number(true, 2);
    
    actualizarSubtotal(fila); 
    actualizarTotalGeneral();
    // calcular subtotal inicial
    //formatNumber()
}



function formatNumberInput(inputElement) {
    let value = parseFloat(inputElement.value);
    if (!isNaN(value) && value >= 0) {
        inputElement.value = new Intl.NumberFormat('es-CO', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value);
    } else {
        inputElement.value = '';
    }
}

function quitarProducto(id, btn) {
    productosAgregados = productosAgregados.filter(pid => pid != id);
    btn.closest("tr").remove();

    actualizarTotalGeneral();
}

// function actualizarSubtotal(elemento) {
//     const fila = elemento.closest("tr");
//     const cantidad = parseFloat(fila.querySelector('input[name="cantidades[]"]').value) || 0;
//      console.log("Tipo:", typeof cantidad);
//     const precio = parseFloat(fila.querySelector('input[name="precios[]"]').value) || 0;
//     console.log("Tipo:", typeof precio);
//     const subtotal = (cantidad * precio);
//     fila.querySelector(".subtotal").innerText = subtotal;

//     console.log(cantidad);
//     console.log(precio);
//     console.log(subtotal);
    
// }


function parsePrecioColombiano(valorRaw) {
    const soloNumeros = valorRaw.replace(/[^0-9.,]/g, '');  // limpia símbolos
    const tieneComaDecimal = soloNumeros.includes(',');
    const tienePuntoDecimal = soloNumeros.includes('.');

    // Caso 1: Formato colombiano: 12.500,00
    if (tieneComaDecimal && tienePuntoDecimal && soloNumeros.indexOf(',') > soloNumeros.indexOf('.')) {
        return parseFloat(soloNumeros.replace(/\./g, '').replace(',', '.'));
    }

    // Caso 2: Formato americano: 12,500.00
    if (tieneComaDecimal && tienePuntoDecimal && soloNumeros.indexOf('.') > soloNumeros.indexOf(',')) {
        return parseFloat(soloNumeros.replace(/,/g, ''));
    }

    // Caso 3: Solo coma (12,50) → 12.50
    if (!tienePuntoDecimal && tieneComaDecimal) {
        return parseFloat(soloNumeros.replace(',', '.'));
    }

    // Caso 4: Solo punto o número limpio
    return parseFloat(soloNumeros);
}


function actualizarSubtotal(input) {
    const fila = input.closest('tr');

    const cantidad = parseFloat(fila.querySelector('input[name="cantidades[]"]').value) || 0;

    const inputPrecio = fila.querySelector('input[name="precios[]"]');
    const raw = inputPrecio.value.trim();
    const precio = parsePrecioColombiano(raw) || 0;  // Solo convierte coma decimal
    // const precio = parseFloat(clean) || 0;
    const subtotal = cantidad * precio;

    fila.querySelector('.subtotal').textContent = subtotal.toLocaleString('es-CO', {
        style: 'currency',
        currency: 'COP',
        minimumFractionDigits: 2
    });

//     console.log(cantidad);
//     console.log("Raw:", raw);      // Lo que ve el usuario
// console.log("Clean:", clean);  // Lo que se va a parsear
// console.log("Precio:", precio);


    console.log(subtotal);

    actualizarTotalGeneral();
    
}





function agregarProveedorAOrden(id, nombre) {
    // Evitar duplicados
    if (productosAgregados.includes(id)) {
        alert("Este proveedor ya ha sido agregado.");
        return;
    }

    productosAgregados.push(id);

    const tbody = document.querySelector("#proveedorSeleccionados tbody");
    const fila = document.createElement("tr");
    fila.setAttribute("data-id", id);

    fila.innerHTML = `
        <td>${nombre}<input type="hidden" name="proveedor[]" value="${id}"></td>
        <td>${proveedor.id_ciudad}</td>
        <td>${proveedor.telefono}</td>
        <td>
            <button type="button" class="btn btn-danger btn-sm" onclick="quitarProducto(${id}, this)">
                <i class="fa fa-times"></i>
            </button>
        </td>
    `;


    tbody.appendChild(fila);
    
}

function actualizarTotalGeneral() {
    let total = 0;
    document.querySelectorAll('#productosSeleccionados tbody tr').forEach(fila => {
        const subtotalTexto = fila.querySelector('.subtotal').textContent;
        const subtotalNum = parsePrecioColombiano(subtotalTexto) || 0;
        total += subtotalNum;
    });

    const totalFormateado = total.toLocaleString('es-CO', {
        style: 'currency',
        currency: 'COP',
        minimumFractionDigits: 2
    });

    document.getElementById('totalOrden').textContent = totalFormateado;

    // Actualizar el campo oculto para enviar al backend
    document.getElementById('inputTotalOrden').value = total.toFixed(2); // Valor limpio, sin formato
}

// function validarCantidad(input) {
//     input.value = input.value.replace(/[^0-9]/g, ''); // solo números enteros positivos
//     if (input.value === '' || parseInt(input.value) < 1) {
//         input.value = 1;
//     }
// }

// function validarPrecio(input) {
//     // Elimina caracteres no permitidos excepto el punto
//     input.value = input.value.replace(/[^0-9.]/g, '');

//     // Limita a 2 decimales
//     let valor = parseFloat(input.value);
//     if (isNaN(valor) || valor < 0) {
//         input.value = '00000000.00';
//     } else {
//         input.value = valor.toFixed(2);
//     }
// }

document.querySelector('form').addEventListener('submit', function() {
    document.querySelectorAll('input[name="precios[]"]').forEach(input => {
        input.value = input.value.replace(/,/g, '');
    });
});
   
</script>

{% endblock %}

{% endblock %}