{% extends 'layouts/base.html' %}
{% load humanize %}

{% block content %}
<style>
.table-success { 
    background-color: #d4edda !important;
    border-left: 4px solid #28a745 !important;
}
.table-warning { 
    background-color: #fff3cd !important;
    border-left: 4px solid #ffc107 !important;
}
.table-light { 
    background-color: #f8f9fa !important;
    border-left: 4px solid #6c757d !important;
}
.badge {
    font-size: 0.75em;
    margin: 1px;
}
</style>
<div class="card shadow">
  <div class="card-header bg-primary text-white">
    <h4 class="mb-0">
      üìã Historial de Entregas de Dotaci√≥n
      {% if cliente and periodo %}
        - {{ cliente }} ({{ periodo }})
      {% elif cliente %}
        - {{ cliente }}
      {% elif periodo %}
        - {{ periodo }}
      {% endif %}
    </h4>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table id="historial_table" class="table table-striped table-hover text-center">
        <thead class="thead-dark">
          <tr>
            <th>Empleado</th>
            <th>C√©dula</th>
            <th>Ciudad</th>
            <th>Centro Costo</th>
            <th>Cargo</th>
            <th>Cliente</th>
            <th>Sexo</th>
            <th>Fecha Generado</th>
            <th>üß• Prendas Entregadas</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
        {% for entrega in entregas %}
{% with completa=entrega.es_entrega_completa faltantes=entrega.productos_faltantes %}
<tr class="{% if completa %}table-success{% elif faltantes %}table-warning{% else %}table-light{% endif %}">
    <td>
        {{ entrega.empleado.nombre }}
        {% if completa %}
            <span class="badge bg-success ms-1" data-bs-toggle="tooltip" title="‚úÖ ENTREGA COMPLETA">
                ‚úÖ
            </span>
        {% elif faltantes %}
            <span class="badge bg-warning ms-1" data-bs-toggle="tooltip" 
                  title="‚ö†Ô∏è ENTREGA PARCIAL - Faltan {{ faltantes|length }} productos">
                ‚ö†Ô∏è
            </span>
        {% else %}
            <span class="badge bg-secondary ms-1" data-bs-toggle="tooltip" 
                  title="‚ÑπÔ∏è Sin grupo de referencia">
                ‚ÑπÔ∏è
            </span>
        {% endif %}
    </td>
    <td>{{ entrega.empleado.cedula }}</td>
    <td>{{ entrega.empleado.ciudad }}</td>
    <td>{{ entrega.empleado.centro_costo }}</td>
    <td>{{ entrega.empleado.cargo }}</td>
    <td>{{ entrega.empleado.cliente }}</td>
    <td>{{ entrega.empleado.sexo }}</td>
    <td>{{ entrega.fecha_entrega|date:"Y-m-d H:i" }}</td>
    <td class="prendas">
        <div class="d-flex flex-wrap gap-1">
            <!-- Productos entregados -->
            {% for detalle in entrega.detalles.all %}
                <span class="badge bg-info text-dark entregado" 
                      data-bs-toggle="tooltip" 
                      title="{{ detalle.producto.descripcion|default:detalle.producto.nombre }}">
                    üëï {{ detalle.producto.nombre }} x{{ detalle.cantidad }}
                </span>
            {% empty %}
                <span class="text-muted">Sin prendas</span>
            {% endfor %}
            
            <!-- Productos faltantes -->
            {% for item in faltantes %}
                <span class="badge bg-danger esperado" 
                      data-bs-toggle="tooltip" 
                      title="Faltan {{ item.cantidad_faltante }} unidad(es)">
                    ‚ùå {{ item.producto.nombre }} x{{ item.cantidad_faltante }}
                </span>
            {% endfor %}
        </div>
        
        <!-- SOLO mostrar tallas del empleado (ocultar grupo) -->
        <small class="text-muted d-block mt-1">
            üë§ Tallas: 
            {% if entrega.empleado.talla_camisa %}Camisa: {{ entrega.empleado.talla_camisa }}{% endif %}
            {% if entrega.empleado.talla_pantalon %}, Pantal√≥n: {{ entrega.empleado.talla_pantalon }}{% endif %}
            {% if entrega.empleado.talla_zapatos %}, Zapatos: {{ entrega.empleado.talla_zapatos }}{% endif %}
        </small>
    </td>
    <td>
        <a href="{% url 'generar_pdf_por_entrega' entrega.id %}" class="btn btn-sm btn-danger">
            <i class="fa fa-file-pdf"></i> PDF
        </a>

         <!-- Mostrar el bot√≥n SOLO si hay faltantes pendientes -->
        {% if entrega.estado != "completa" and faltantes %}
        <a href="{% url 'generar_entrega_faltantes' entrega.id %}" 
        class="btn btn-sm btn-info mt-1 "
        onclick="return confirm('¬øConfirmas entregar los faltantes de esta entrega?');">
            <i class="fa fa-truck"></i> Entregar faltantes
        </a>
        {% endif %}

    </td>
</tr>
{% endwith %}
{% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>


{% block extra_js %}
<script>
 $(document).ready(function () {
    if (!$.fn.DataTable.isDataTable('#historialTable')) {
        $('#historialTable').DataTable();
    }
});
if (!$.fn.DataTable.isDataTable('#historialTable')) {
    $('#historialTable').DataTable();
} 
$(document).ready(function() {
    $('#historial_table').DataTable({
        responsive: true,
        paging: true,
        searching: true,
        ordering: true,
        order: [[1, "desc"]],
        language: {
            search: "Buscar:",
            lengthMenu: "Mostrar _MENU_ registros por p√°gina",
            zeroRecords: "No se encontraron resultados",
            info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
            infoEmpty: "No hay registros disponibles",
            infoFiltered: "(filtrado de _MAX_ registros totales)",
            paginate: {
                first: "Primero",
                last: "√öltimo",
                next: "Siguiente",
                previous: "Anterior"
            }
        }
    });
    // Inicializar tooltips de Bootstrap
    $('[data-toggle="tooltip"]').tooltip();
});




</script>
{% endblock %}

{% endblock %}