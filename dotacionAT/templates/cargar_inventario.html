{% extends 'layouts/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}

<div class="content-wrapper">
    <section class="content-header">
        <br>
        <h1 style="color: black;">
        Cargar Inventario
        </h1>
    </section>
            
    <div class="row">  
        <div class="col-lg-7 col-md-7 col-sm-12 col-xs-12">
    <!--=====================================
    ENTRADA PARA PROVEEDOR
    ======================================-->
   <!-- <div class="card " style="color: black;">
        <div class="card-header bg-success">
            <h3 class="card-title">Seleccione Proveedor</h3>
        </div>
        <div class="card-body">
        <table id="tablaProveedoresOrden" class="table table-striped table-responsive-sm text-center" data-page-length="1" width="100%">
            <thead class="thead-dark">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody id="tableBody_proveedorOrden" style="color: black;"></tbody>
        </table>
    </div>
    </div> -->
    <br>
    <div class="card">
        
        <form id="formInventario" method="POST" action="{% url 'registrar_inventario_inicial' %}">
    {% csrf_token %}
        <div class="box-body">
        <div class="box">

    <!--=====================================
    ENTRADA FECHA FACTURA DE COMPRA
    ======================================-->

    <!--=====================================
    ENTRADA DEL PROVEEDOR
    ======================================-->
    <div class="form-group row nuevoProveedor">
    </div>
    <input type="hidden" id="listaProveedor" name="listaProveedor">
    

    <div class="form-group row nuevoProveedor mt-3">
        <label class="col-sm-12 col-form-label"><strong></strong></label> 
        <div class="col-sm-12">
            <table class="table table-bordered text-center" id="proveedorSeleccionado">
                <thead class="thead-dark">
                    <tr>
                        <th>Nombre</th>
                        <!-- <th>Ciudad</th>
                        <th>Telefono</th> -->
                    </tr>
                </thead>
                <tbody style="color: black;">
                <td>Atiempo SAS<input type="hidden" name="proveedor" value=""></td>
                <!-- <td>Bogotá<input type="hidden" value=""></td>
                <td><input type="hidden" value=""></td> -->
                
                </tbody>
            </table>
        </div>
    </div>
</br> 
    <!--=====================================
    ENTRADA PARA AGREGAR PRODUCTO
    ======================================-->
  
    <!-- <div class="form-group row nuevoProductoCompra"> -->
  
    <input type="hidden" id="listaProductos" name="listaProductos">

    <div class="form-group row nuevoProductoCompra mt-3">
        <!-- <label class="col-sm-12 col-form-label"><strong>Productos Seleccionados</strong></label> -->
        <div class="col-sm-12">
            <table class="table table-bordered text-center" id="productosSeleccionados">
                <thead class="thead-dark">
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <!-- <th>Precio</th>
                        <th>Subtotal</th> -->
                        <th>Quitar</th>
                    </tr>
                </thead>
                <tbody style="color: black;"></tbody>
                <!--<tfoot style="color: black;">
                    <tr >
                      <td colspan="3" class="text-end"><strong>Total:</strong></td>
                      <td id="totalOrden"  class="text-right">COP 0.00</td>
                      <td></td>
                      <input type="hidden" name="total_orden" id="inputTotalOrden">
                    </tr>
                   
                  </tfoot> -->
            </table>
        </div>
    </div>
    <!--=====================================
    BOTÓN PARA AGREGAR PRODUCTO
    ======================================-->

        </div>
        
    </div>
<!-- <div class="form-group"> -->

<div class="form-row">
    <div class="form-group col-md-6">
        <label for="observaciones">Observación</label>
        <input type="text" id="observaciones" name="observaciones" class="form-control" placeholder="Observación del inventario">
    </div>

     <div class="form-group col-md-6">
    <label for="selectBodega">Bodega:</label>
    <select id="selectBodega" name="bodega" class="form-control" required>
      <option value="">Seleccione una bodega</option>
      {% for bodega in bodegas %}
        <option value="{{ bodega.id_bodega }}">{{ bodega.nombre }}</option>
      {% endfor %}
    </select>
  </div>
  <!-- <p>DEBUG bodegas: {{ bodegas|length }} bodegas encontradas</p>
{% for b in bodegas %}
  <p>{{ b.id_bodega }} - {{ b.nombre }}</p>
{% endfor %} -->
</div>
<!-- </div> -->


    <button type="submit" class="btn btn-success">Guardar Inventario</button>        
</form>
        
        </div>
    </div>

<!-- <div class="box-header with-border"></div> -->
<div class="col-lg-4 col-md-4 col-sm-12 col-xs-12">
    <div class="card " style="color: black;">
        <div class="card-header bg-warning">
            <h3 class="card-title" style="color: white;">Seleccione Producto</h3>
        </div>
        <div class="card-body">
     
        <table class="table table-striped table-hover table-responsive-sm text-center " id="datatableProductosInventario">
            <thead class="thead-dark">
              <tr>
                <th >ID</th>
                <th >Nombre</th>
                <th >Acciones</th>
              </tr>
            </thead>
           <tbody id="tableBody_productosOrden" style="color: black;"></tbody>
      
            </table>

    </div>
    </div>
    </div>
    

</div>
</div>

{% block extra_js %}

<script>

// let dataTableProveedores;
let dataTableProductos;

let proveedoresInitialized = false;
let productosInitialized = false;

const dataTableOptions = {
    columnDefs: [
        { className: "text-center", targets: "_all" },
        { orderable: false, targets: -1 }
    ],
    pageLength: 1,
    destroy: true,
    language: {
        processing: "Procesando...",
        lengthMenu: "Mostrar _MENU_ registros",
        zeroRecords: "No se encontraron resultados",
        emptyTable: "Ningún dato disponible en esta tabla",
        info: "Mostrando registros del _START_ al _END_ de un total de _TOTAL_",
        infoEmpty: "Mostrando 0 de 0 registros",
        infoFiltered: "(filtrado de un total de _MAX_ registros)",
        search: "Buscar:",
        paginate: {
            first: "Primero",
            last: "Último",
            next: "Siguiente",
            previous: "Anterior"
        },
    },
    lengthChange: false,
};

const cargarProveedores = async () => {
    try {
        const response = await fetch('/list_proveedores/');
        const data = await response.json();
        const tableBody = document.getElementById('tableBody_proveedorOrden');

        if (tableBody) {
            let content = ``;

            data.proveedores.forEach(proveedor => {
                const activo = proveedor.activo === true || proveedor.activo === "True";
                content += `
                    <tr>
                        <td>${proveedor.id_proveedor}</td>
                        <td>${proveedor.nombre}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-primary"
                                onclick="seleccionarProveedor('${proveedor.id_proveedor}', '${proveedor.nombre}', '${proveedor.id_ciudad}', '${proveedor.telefono}')">
                                Seleccionar
                            </button>
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = content;
        }

    } catch (error) {
        console.error("Error al cargar proveedores:", error);
    }
};


const dataTableOptionsOrden = {
    columnDefs: [
        { className: "text-center", targets: "_all" },
        { orderable: false, targets: -1 }
    ],
    pageLength: 10,
    destroy: true,
    language: {
        processing: "Procesando...",
        lengthMenu: "Mostrar _MENU_ registros",
        zeroRecords: "No se encontraron resultados",
        emptyTable: "Ningún dato disponible en esta tabla",
        info: "Mostrando registros del _START_ al _END_ de un total de _TOTAL_",
        infoEmpty: "Mostrando 0 de 0 registros",
        infoFiltered: "(filtrado de un total de _MAX_ registros)",
        search: "Buscar:"   
    }
    // paging: false,
    //info: false,
};

// ✅ Tabla de Productos
const initDataTableProductos = async () => {
    if (productosInitialized) {
        dataTableProductos.destroy();
    }

    await cargarProductos();

    const table = document.getElementById('datatableProductosInventario');
    if (table) {
        dataTableProductos = $('#datatableProductosInventario').DataTable(dataTableOptionsOrden);
        productosInitialized = true;
    }
};

const cargarProductos = async () => {
    try {
        const response = await fetch('/list_productos/');
        const data = await response.json();
        const tableBody = document.getElementById('tableBody_productosOrden');

        if (tableBody) {
            let content = ``;
            data.productos.forEach(producto => {
                const activo = producto.activo === "True" || producto.activo === true;
                content += `
                    <tr class="text-center">
                        <td>${producto.id_producto}</td>
                        <td>${producto.nombre}</td>
                        <td>
                            
                                  <button class="btn btn-sm btn-primary" onclick="agregarProductoAOrden('${producto.id_producto}', '${producto.nombre}', '${producto.costo}')">
        Agregar
    </button>
                        </td>
                    </tr>
                `;
            });
            tableBody.innerHTML = content;
        }

    } catch (error) {
        alert("Error al obtener productos.");
        console.error("Error al obtener productos:", error);
    }
};

// ✅ Llamamos ambas al cargar la página
window.addEventListener("load", async () => {
    //await initDataTableProveedores();
    await initDataTableProductos();
    console.log("Página cargada");
});


let productosAgregados = [];

function agregarProductoAOrden(id, nombre, costo) {
    // Evitar duplicados
    if (productosAgregados.includes(id)) {
        alert("Este producto ya ha sido agregado.");
        return;
    }

    productosAgregados.push(id);

    const tbody = document.querySelector("#productosSeleccionados tbody");
    const fila = document.createElement("tr");
    fila.setAttribute("data-id", id);

    fila.innerHTML = `
        <td>${nombre}<input type="hidden" name="productos[]" value="${id}"></td>
        <td>
            <input type="text" name="cantidades[]" class="form-control text-center cantidad" value="1"  min="0" step="0.01"  required></td>

            <button type="button" class="btn btn-danger btn-sm" onclick="quitarProducto(${id}, this)">
                <i class="fa fa-times"></i>
            </button>
        </td>
    `;
    tbody.appendChild(fila);
    
    console.log(typeof $.fn.number);
    
    $(fila).find(".valorUnitario").number(true, 2);
    // $(fila).find(".cantidad").number(true);
    $(fila).find(".subtotal").number(true, 2);
    
}

function formatNumberInput(inputElement) {
    let value = parseFloat(inputElement.value);
    if (!isNaN(value) && value >= 0) {
        inputElement.value = new Intl.NumberFormat('es-CO', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value);
    } else {
        inputElement.value = '';
    }
}

function quitarProducto(id, btn) {
    productosAgregados = productosAgregados.filter(pid => pid != id);
    btn.closest("tr").remove();

}



document.querySelector('form').addEventListener('submit', function() {
    document.querySelectorAll('input[name="precios[]"]').forEach(input => {
        input.value = input.value.replace(/,/g, '');
    });
});



document.addEventListener('DOMContentLoaded', function () {
   fetch('/list_bodegas_filtradas/')
   .then(response => response.json())
   .then(data => {
       const select = document.getElementById('selectBodega');
       select.innerHTML = '<option value="">Seleccione una bodega</option>';

       data.bodegas.forEach(bodega => {  // <-- ¡Aquí va data.bodegas!
           const option = document.createElement('option');
           option.value = bodega.id_bodega;
           option.textContent = bodega.nombre + ' - ' + bodega.ciudad;
           select.appendChild(option);
       });
   })
   .catch(error => {
       console.error('Error al cargar las bodegas:', error);
       const select = document.getElementById('selectBodega');
       select.innerHTML = '<option value="">Error al cargar</option>';
   })
});



document.getElementById("formInventario").addEventListener("submit", async function(e) {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);

    try {
        const response = await fetch("/registrar_inventario_inicial/", {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": formData.get("csrfmiddlewaretoken")
            }
        });

        const data = await response.json();

        if (data.success) {
            Swal.fire({
                icon: "success",
                title: "¡Inventario registrado!",
                text: data.message,
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: true
            }).then(() => {
                window.location.href = "/inventario_bodega_list/";
            });
        } else {
            Swal.fire({
                icon: "error",
                title: "Error al registrar",
                text: data.message || "Ocurrió un error inesperado."
            });
        }
    } catch (error) {
        Swal.fire({
            icon: "error",
            title: "Error del servidor",
            text: "No se pudo procesar la solicitud."
        });
        console.error("Error:", error);
    }
});

</script>

{% endblock %}
{% endblock %}