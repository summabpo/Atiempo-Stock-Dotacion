{% extends 'layouts/base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<style>
#consolidado_table th {
    color: white;
    text-align: center;
}
#consolidado_table td {
    vertical-align: middle;
}
.dataTables_wrapper .dataTables_paginate .paginate_button {
    padding: 0.2rem 0.6rem;
    margin-left: 2px;
}


#consolidado_table th {
    color: white;
    text-align: center;
}
#consolidado_table td {
    vertical-align: middle;
}

/* üîπ Estilo para paginaci√≥n DataTables */
.dataTables_wrapper .dataTables_paginate .paginate_button {
    padding: 0.2rem 0.6rem;
    margin-left: 2px;
}

/* üéØ Limitar ancho y ajustar texto en columnas largas */
#consolidado_table th:nth-child(1),
#consolidado_table td:nth-child(1) {
    max-width: 200px;          /* Cliente */
    white-space: normal;
    word-wrap: break-word;
    text-align: left;
}

#consolidado_table th:nth-child(3),
#consolidado_table td:nth-child(3) {
    max-width: 180px;          /* Centro Costo */
    white-space: normal;
    word-wrap: break-word;
    text-align: left;
}


#consolidado_table td .btn {
    display: block;               /* Cada bot√≥n en su l√≠nea */
    width: 90%;                   /* Un poco m√°s estrecho para no pegarse a los bordes */
    margin: 3px auto;             /* Centrado con peque√±o espacio vertical */
    white-space: nowrap;          /* Evita que el texto se parta en varias l√≠neas */
}

#consolidado_table td {
    vertical-align: middle;       /* Centra el contenido verticalmente */
    text-align: center;           /* Centra horizontalmente los botones */
}

#consolidado_table th {
    white-space: normal !important;  /* permite salto de l√≠nea */
    line-height: 1.1;
    font-size: 13px;
    padding-top: 4px;
    padding-bottom: 4px;
}

</style>

<h2>üìä Consolidado - Periodo {{ periodo }}</h2>

<table id="consolidado_table" class="table table-striped table-hover table-bordered dt-responsive nowrap text-center" style="width:100%">
    <thead class="thead-dark">
        <tr>
            <th>Cliente</th>
            <th>Ciudad</th>
            <th>Centro Costo</th>
            <th>Periodo</th>
            <th>Tipo<br>Entrega</th>
            <th>Total<br>Entregas</th>
            <th>Fecha<br>Registro</th>
            <th>Bodega</th>
            <th>Estado</th>
            <th>Acci√≥n</th>
        </tr>
    </thead>
    <tbody>

    {% for fila in consolidado %}
        <tr class="{% if fila.tiene_parciales %}table-warning{% else %}table-success{% endif %}">
            <td>{{ fila.empleado__cliente__nombre }}</td>
            <td>{{ fila.empleado__ciudad__nombre }}</td>
            <td>{{ fila.empleado__centro_costo }}</td>
            <td>{{ fila.periodo }}</td>
            <td>{{ fila.tipo_entrega }}</td>
            <td>{{ fila.total_entregas }}</td>
            
            <td>{{ fila.fecha_minuto|date:"Y-m-d H:i" }}</td> <!-- ‚úÖ muestra limpio -->
            <td>{{ fila.bodega__nombre }}</td>
            <td>
                {% if fila.tiene_parciales %}
                    ‚ö†Ô∏è Parciales ({{ fila.parciales }})
                {% else %}
                    ‚úÖ Completas ({{ fila.completas }})
                {% endif %}
            </td>
            <td>
                <a href="{% url 'generar_pdf_por_periodo' %}?periodo={{ fila.periodo }}&cliente_id={{ fila.empleado__cliente__id_cliente }}&tipo_entrega={{ fila.tipo_entrega }}&ciudad_id={{ fila.empleado__ciudad__id_ciudad }}&centro_costo={{ fila.empleado__centro_costo }}"
                   class="btn btn-primary btn-sm">
                    üìÑ PDF Lote
                </a>

                <a href="{% url 'historial_entregas' %}?periodo={{ fila.periodo }}&cliente_id={{ fila.empleado__cliente__id_cliente }}&tipo_entrega={{ fila.tipo_entrega }}&ciudad_id={{ fila.empleado__ciudad__id_ciudad }}&centro_costo={{ fila.empleado__centro_costo }}"
                   class="btn btn-info btn-sm">
                    üìã Ver Detalles
                </a>
            </td>
        </tr>
    {% empty %}
        <tr>
            <td colspan="8">No hay entregas registradas.</td>
        </tr>
    {% endfor %}
    </tbody>
</table>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    $('#consolidado_table').DataTable({
        responsive: true,
        paging: true,
        searching: true,
        ordering: true,
        order: [[1, "desc"]],
        language: {
            search: "Buscar:",
            lengthMenu: "Mostrar _MENU_ registros por p√°gina",
            zeroRecords: "No se encontraron resultados",
            info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
            infoEmpty: "No hay registros disponibles",
            infoFiltered: "(filtrado de _MAX_ registros totales)",
            paginate: {
                first: "Primero",
                last: "√öltimo",
                next: "Siguiente",
                previous: "Anterior"
            }
        }
    });
});
</script>
{% endblock %}